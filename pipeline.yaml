trigger:
- main  # Change this to your branch if needed

pool:
  name: self  # Replace with your actual self-hosted agent pool name

variables:
  TF_CLOUD_API_TOKEN: $(TF_CLOUD_API_TOKEN)  # From variable group
  WORKSPACE_NAME: $(WORKSPACE_NAME)            # From variable group
  TF_CLOUD_ORG: $(TF_CLOUD_ORG)                # From variable group

stages:
- stage: TriggerTerraformCloud
  jobs:
  - job: TriggerRun
    displayName: 'Trigger Terraform Cloud Run'
    pool:
      name: self  # Ensure this is your self-hosted pool
    steps:
    - checkout: self

    - powershell: |
        $data = @{
          data = @{
            attributes = @{
              "is-destroy" = $false
            }
            type = "runs"
            relationships = @{
              workspace = @{
                data = @{
                  type = "workspaces"
                  id = "$env:TF_CLOUD_ORG/$env:WORKSPACE_NAME"
                }
              }
            }
          }
        }

        $jsonData = $data | ConvertTo-Json -Depth 10

        $response = Invoke-RestMethod -Uri 'https://app.terraform.io/api/v2/runs' `
            -Method Post `
            -Headers @{
              "Authorization" = "Bearer $env:TF_CLOUD_API_TOKEN"
              "Content-Type" = "application/vnd.api+json"
            } `
            -Body $jsonData

        Write-Host "Response: $($response | ConvertTo-Json -Depth 10)"
      displayName: 'Trigger Terraform Cloud Run'
